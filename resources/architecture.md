# Skurge Architecture #

### Table of Contents
* [Skurge flow](#Skurge-flow)
* [Skurge database tables](#Skurge-database-tables)
* [ER Diagram](#ER-Diagram)

## Skurge flow
* First, the source event and corresponding data & relay processors needs to be registered in skurge.
* The flow is triggered by hitting the registered source event with necessary payload.
* The source event payload is validated.
* The data processing flow optionally fetches data from a graphql server, validates and transforms data to form the destination payload.
* The relay processor decides the destination which may be an HTTP endpoint or messaging queue and relays the destination payload to the same.
<br /><br />
![flow_diagram](flow_diagram.png)

## Skurge database tables
| Table            | Column                    | Remarks                                                                                                                                                                                                                                                                                                            |
|:-----------------|:--------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| source_events    | id                        | Primary key                                                                                                                                                                                                                                                                                                        |
|                  | is_deleted                | True/False for soft deletion                                                                                                                                                                                                                                                                                       |
|                  | is_active                 | True/False to activate or deactivate flow related to this source event.                                                                                                                                                                                                                                            |
|                  | source_event              | Name of the source event. You need to call Skurge's event processing API with this name to trigger the related flow.                                                                                                                                                                                               |
|                  | input_json_schema         | [JsonSchema](https://json-schema.org/) to validate the data received by Skurge.                                                                                                                                                                                                                                    |
| data_processors  | id                        | Primary key                                                                                                                                                                                                                                                                                                        |
|                  | is_deleted                | True/False for soft deletion                                                                                                                                                                                                                                                                                       |
|                  | graphql_query             | Graphql query to fetch more data from your graphql service. The params needed for the queries should be received as input payload by skurge.                                                                                                                                                                       |
|                  | relay_data_locator        | The column uses [JsonLogic](https://jsonlogic.com/) for conditional if-else logic. It uses [GET](https://pydash.readthedocs.io/en/latest/api.html#pydash.objects.get) method of pydash library to get values from data dictionary received from your graphql service and input data dictionary received by skurge. |
|                  | default response          | Default data (Eg. constants) to be relayed can be kept here as a dictionary. The dictionary values support python's [string format method](https://docs.python.org/3/library/stdtypes.html#str.format).                                                                                                            |
|                  | relay_json_schema         | [JsonSchema](https://json-schema.org/) to validate the final payload to be relayed. Final event payload is prepared by relay_data_locator and default_response.                                                                                                                                                    |
| relay_processors | id                        | Primary key                                                                                                                                                                                                                                                                                                        |
|                  | source_event_id           | id of table `source_events`                                                                                                                                                                                                                                                                                        |
|                  | data_processor_id         | id of table `data_processors`                                                                                                                                                                                                                                                                                      |
|                  | is_deleted                | True/False for soft deletion                                                                                                                                                                                                                                                                                       |
|                  | is_active                 | True/False to activate or deactivate the relayer                                                                                                                                                                                                                                                                   |
|                  | relay_type                | This should be `EVENT` if you want to publish event to messaging queue or `API` if you want to hit HTTP endpoint                                                                                                                                                                                                   |
|                  | relay_system              | Here you can add name of system where final payload is relayed                                                                                                                                                                                                                                                     |
|                  | relay_event_rules         | Uses [JsonLogic](https://jsonlogic.com/) library to make relaying decisions when you are publishing `EVENT`. Eg. You may want to relay data to different systems or only if certain conditions are fulfilled.                                                                                                      |
|                  | relay_http_endpoint_rules | Uses [JsonLogic](https://jsonlogic.com/) library to make relaying decisions when you are hitting `HTTP` endpoint. The string values support python's [string format method](https://docs.python.org/3/library/stdtypes.html#str.format).                                                                           |
|                  | context_data_locator      | Uses [GET](https://pydash.readthedocs.io/en/latest/api.html#pydash.objects.get) method of pydash library to form data dictionary to be used for decision making by `relay_event_rules` or `relay_http_endpoint_rules` column.                                                                                      |
| relay_logs       | id                        | Primary key                                                                                                                                                                                                                                                                                                        |
|                  | source_event_name         | Name of source event                                                                                                                                                                                                                                                                                               |
|                  | destination_relay_name    | Name of destination system where data was relayed                                                                                                                                                                                                                                                                  |
|                  | relay_type                | `EVENT` if data was relayed by publishing event to your messaging queue and `API` for HTTP endpoint                                                                                                                                                                                                                |
|                  | relay_data                | Final data relayed                                                                                                                                                                                                                                                                                                 |
|                  | status                    | `SUCCESS` / `FAILURE`                                                                                                                                                                                                                                                                                              |
|                  | reason                    | Error message                                                                                                                                                                                                                                                                                                      |


## ER Diagram
* The ER diagram for tables `source_events`, `data_processors` and `relay_processors` tables:
<br /><br />
![er_diagram](er_diagram.png)
